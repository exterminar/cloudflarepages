<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tamales de Danely</title>
<style>
/* 01/21/2026 - Armando Gomez armando@odnamra.com */
/* ---------- Base / Theme (Mexican traditional) ---------- */
:root{
--bg:#FFEFD5; /* light parchment */
--accent:#E65100; /* burnt orange */
--accent-dark:#7A2B17; /* deep brown/red */
--muted:#8C5A2D;
--card:#FFF3E6;
--cta:#A22A18;
--cta-text:#FFF0D9;
--success:#2E7D32;
--max-width:30em;
--gap:0.875em;
}
html,body{height:100%;}
body{
margin:0;
font-family: Inter, system-ui, -apple-system, "Helvetica Neue", Arial;
background:linear-gradient(180deg,var(--bg),#FFDDB3);
color:var(--accent-dark);
display:flex;
align-items:flex-start;
justify-content:center;
padding:1.25em 0.75em;
}
.screen{
width:100%;
max-width:var(--max-width);
background:linear-gradient(180deg, #FFF8F0, #FFF3E6);
border-radius:1em;
box-shadow:0 0.5em 1.875em rgba(0,0,0,0.12);
overflow:hidden;
border:0.375em solid #FFDE9A;
}
header{
padding:1.25em 1.125em;
background:
linear-gradient(180deg,#FF9C1A,#FFA43B);
color:var(--card);
position:relative;
display:flex;
align-items:center;
justify-content:space-between;
gap:0.5em;
}
header h1{
margin:0;
font-family: "Georgia", serif;
font-size:1.75em;
letter-spacing:0.02em;
text-shadow:0 0.0625em 0 rgba(0,0,0,0.12);
cursor:pointer;
flex-shrink:1;
min-width:0;
}
.lang-toggle{
display:flex;
gap:0.375em;
align-items:center;
flex-shrink:0;
}
.lang-toggle button{
background:transparent;
color:var(--card);
border:0.0625em solid rgba(255,255,255,0.25);
padding:0.375em 0.5em;
border-radius:0.375em;
font-weight:600;
font-size:0.8125em;
cursor:pointer;
white-space:nowrap;
}

/* Responsive adjustments */
@media (max-width:420px){
header h1{font-size:1.35em}
.lang-toggle button{font-size:0.75em;padding:0.3em 0.4em}
}
main{
padding: 1.125em 1.125em 1.75em;
}
.hero{
text-align:center;
margin-bottom:0.75em;
}
.hero h2{
margin:0.375em 0 0;
font-size:1.25em;
}
.hero p{margin:0.375em 0 0;color:var(--muted);font-size:0.8125em}
.actions{display:flex;gap:0.75em; justify-content:center; margin-top:0.875em;}
.btn{
border:0;
padding:0.75em 0.875em;
border-radius:0.625em;
font-weight:700;
cursor:pointer;
box-shadow:0 0.25em 0.625em rgba(0,0,0,0.08);
}
.btn.primary{
background:var(--cta);
color:var(--cta-text);
flex:1;
}
.btn.ghost{
background:rgba(255,255,255,0.9);
color:var(--accent-dark);
border:0.0625em solid rgba(0,0,0,0.03);
flex:1;
}

/* Forms */
.card{
background:var(--card);
border-radius:0.75em;
padding:0.875em;
margin-bottom:0.75em;
}
label{display:block;font-size:0.8125em;margin-bottom:0.375em;color:var(--muted);}
input[type="text"], input[type="email"], input[type="date"], input[type="tel"]{
width:100%;
padding:0.625em 0.75em;
border-radius:0.5em;
border:0.0625em solid rgba(0,0,0,0.06);
box-sizing:border-box;
font-size:0.9375em;
margin-bottom:0.75em;
background:#fff;
}
.muted{color:var(--muted);font-size:0.8125em}
.center{text-align:center}
.small{font-size:0.8125em}

/* Menu card */
.menu-card{display:flex;gap:0.75em;align-items:center;transition:opacity 0.3s ease;}
.menu-card.faded{opacity:0.4;}
.tamale-illus{
  width:auto;
  height:auto;
  min-width:1.375em;
  min-height:1.375em;
  border-radius:0.75em;
  padding:0.2em;

  /* Gradient + corn husk texture with dynamic color */
  background:
    repeating-linear-gradient(
      135deg,
      rgba(255,255,255,0.18) 0em,
      rgba(255,255,255,0.18) 0.375em,
      rgba(255,255,255,0.08) 0.375em,
      rgba(255,255,255,0.08) 0.75em
    ),
    linear-gradient(180deg, var(--tamale-color, #FFB66B), color-mix(in srgb, var(--tamale-color, #FFB66B) 70%, black));

  background-blend-mode: overlay;

  display:flex;
  align-items:center;
  justify-content:center;
  font-size:5em;
  line-height:1;

  box-shadow:
    inset 0 -0.25em 0.625em rgba(0,0,0,0.06),
    inset 0 0.25em 0.5em rgba(255,255,255,0.25);
}
.menu-right{flex:1}
.price{font-weight:800;margin-top:0.375em;color:var(--cta-text);background:var(--accent-dark);display:inline-block;padding:0.375em 0.5em;border-radius:0.5em;font-size:0.8125em}
.qty{
display:flex;align-items:center;gap:0.5em;margin-top:0.75em;
}
.qty button{
width:3em;height:2.75em;border-radius:0.625em;border:0.0625em solid rgba(0,0,0,0.06);
background:#fff;font-weight:700;font-size:1.125em;cursor:pointer;
transition: opacity 0.3s ease, background 0.3s ease;
}
.qty button:disabled{
opacity:0.3;
cursor:not-allowed;
background:#f5f5f5;
}
.qty .count{min-width:3.625em;text-align:center;font-weight:800;font-size:1.125em}
.total{margin-top:0.75em;font-weight:800;font-size:1.125em;color:var(--accent-dark)}

footer{background:linear-gradient(180deg,#FFDDA9,#FFDE9A);padding:0.625em;text-align:center;font-size:0.8125em;color:var(--accent-dark)}
.note{font-size:0.75em;color:var(--muted);margin-top:0.5em}

/* Responsive adjustments */
@media (max-width:420px){
header h1{font-size:1.5em}
}

/* tiny utility */
.hidden{display:none!important}
.linkish{background:none;border:none;color:var(--accent-dark);text-decoration:underline;cursor:pointer;padding:0;font-size:0.8125em}

@keyframes slideDown {
  from { transform: translate(-50%, -100%); opacity: 0; }
  to { transform: translate(-50%, 0); opacity: 1; }
}

@keyframes slideUp {
  from { transform: translate(-50%, 0); opacity: 1; }
  to { transform: translate(-50%, -100%); opacity: 0; }
}

</style>
</head>
<body>
<div class="screen" role="application" aria-label="Danely's Tamales app">
<header>
<h1 id="brand">Tamales de Danely</h1>
<div class="lang-toggle" role="toolbar" aria-label="Language toggle">
<button id="btn-en">EN</button>
<button id="btn-es">ES</button>
<button id="goAccount" class="hidden">Account</button>
</div>
</header>

<main id="app">

<!-- HOME -->
<section id="home" class="view">
<div class="hero">
<h2 id="hero-title">Handmade Tamales Made Every Month</h2>
<p id="hero-sub">Cash & Pickup only.</p>
</div>

<div class="actions card" style="padding:0.75em;" id="auth-buttons">
<button id="goSignUp" class="btn primary">Sign Up</button>
<button id="goLogin" class="btn ghost">Log In</button>
</div>

<div class="card hidden" id="logged-in-card" style="text-align:center;padding:0.75em;">
<p class="muted" style="margin:0"><span id="logged-in-text">Logged in as:</span> <strong id="logged-in-name"></strong></p>
</div>

<div class="card">
<h3 id="this-month">This Month's Tamales (Order by Jan 22)</h3>
<div id="tamales-container">
<!-- Tamales will be dynamically rendered here -->
</div>
<div style="margin-top:0.75em">
<button id="placeOrderBtn" class="btn primary" style="width:100%">Place Order</button>
</div>
</div>

<div class="note center" id="pickup-note">No shipping. Pickup only at Danely's House. Cash only.</div>
</section>

<!-- SIGN UP -->
<section id="signup" class="view hidden">
<div class="card">
<h3 id="signup-title">Create Account</h3>
<label for="name" id="label-name">Name</label>
<input id="name" type="text" placeholder="Full name">

<label for="birthday" id="label-bday">Birthday</label>
<input id="birthday" type="date">

<label for="email" id="label-email">Email</label>
<input id="email" type="email" placeholder="you@example.com">

<label for="phone" id="label-phone">Phone</label>
<input id="phone" type="tel" placeholder="(555) 555-5555">

<div style="display:flex;gap:0.625em;">
<button id="createAccount" class="btn primary" style="flex:1">Create Account</button>
<button id="backFromSignup" class="btn ghost" style="flex:1">Back</button>
</div>

<p class="muted small" style="margin-top:0.625em">
We will send a 6-digit verification code to your email to finish signing up.
</p>
</div>
</section>

<!-- VERIFY -->
<section id="verify" class="view hidden">
<div class="card">
<h3 id="verify-title">Verify Email</h3>
<p class="muted small" id="sent-to">We sent a 6-digit code to </p>
<label for="codeInput" id="label-code">Enter code</label>
<input id="codeInput" type="text" maxlength="6" placeholder="123456">
<div style="display:flex;gap:0.625em;">
<button id="submitCode" class="btn primary" style="flex:1">Submit</button>
<button id="resendCode" class="btn ghost" style="flex:1">Resend</button>
</div>
<p id="verify-hint" class="muted small">
Check your email for the 6-digit verification code.
</p>
</div>
<div style="padding:0 1.125em 1.125em;">
<button id="backFromVerify" class="linkish">Back</button>
</div>
</section>

<!-- LOGIN -->
<section id="login" class="view hidden">
<div class="card">
<h3 id="login-title">Log In</h3>
<label for="loginEmail" id="label-login-email">Email</label>
<input id="loginEmail" type="email" placeholder="you@example.com">
<label for="loginBday" id="label-login-bday">Birthday</label>
<input id="loginBday" type="date">
<div style="display:flex;gap:0.625em;">
<button id="loginButton" class="btn primary" style="flex:1">Log In</button>
<button id="backFromLogin" class="btn ghost" style="flex:1">Back</button>
</div>
<p class="muted small" id="login-hint">Enter your email and birthday to log in.</p>
</div>
</section>

<!-- ACCOUNT / ORDERS -->
<section id="account" class="view hidden">
<div class="card">
<h3 id="account-title">My Account</h3>
<div id="accountInfo" class="muted small"></div>
</div>

<div class="card">
<h4 id="past-orders-title">Past Orders</h4>
<div id="pastOrders" class="muted small">No past orders</div>
</div>

<div style="padding:0 1.125em 1.125em;display:flex;gap:0.625em;">
<button id="backToHome" class="btn primary" style="flex:1">Back to Menu</button>
<button id="logoutBtn" class="btn ghost" style="flex:1">Log Out</button>
</div>
</section>

<!-- CONFIRMATION -->
<section id="confirm" class="view hidden">
<div class="card">
<h3 id="confirm-title" class="center">Order Summary</h3>
<div id="confirm-summary" style="margin-top:1em"></div>
<div style="display:flex;gap:0.625em;margin-top:1em;">
<button id="placeOrderBtn2" class="btn primary" style="flex:1">Place Order</button>
<button id="modifyOrder" class="btn ghost" style="flex:1">Modify Order</button>
</div>
<p class="muted small center" id="confirm-hint">
Your order will be emailed to Danely and a confirmation will be sent to you.
</p>
</div>
</section>

</main>

<footer>
<div id="footer-text">Â© 2025 Armando Gomez. All rights reserved.</div>
</footer>
</div>

<script>

// ========== MONTHLY CONFIGURATION - UPDATE THESE DATES ==========
const ORDER_BY_DATE = 'Jan 29';  // Deadline to place orders
const PICKUP_DATE = 'Feb 2';    // Date customers pick up orders
// ================================================================

/* ---------- Strings for EN / ES ---------- */
const STRINGS = {
en: {
brand: "Tamales de Danely",
heroTitle: "Different Tamales every month",
heroSub: "Handmade by Danely. Pay cash only.",
signUp: "Register",
logIn: "Log In",
account: "Account",
loggedInAs: "Logged in as:",
thismonth: `This Month's Tamales (Order by ${ORDER_BY_DATE})`,
placeOrder: "Place Order",
deleteOrder: "Delete",
confirmDelete: "Are you sure you want to delete this order?",
orderPlaced: "Your order has been placed! Check your email for confirmation.",
orderPlacedTitle: "Order Confirmed!",
createAccount: "Create Account",
back: "Back",
name: "Name",
bday: "Birthday",
email: "Email",
phone: "Phone",
verifyTitle: "Verify Email",
sentTo: "We sent a 6-digit code to",
submit: "Submit",
resend: "Resend",
loginTitle: "Log In",
loginEmailLabel: "Email",
loginBdayLabel: "Birthday",
loginButton: "Log In",
loginHint: "Enter your email and birthday to log in.",
accountTitle: "My Account",
pastOrders: "Past Orders",
noPastOrders: "No past orders",
backToMenu: "Back to Menu",
logout: "Log Out",
confirmTitle: "Order Summary",
placeOrderBtn: "Place Order",
modifyOrder: "Modify Order",
confirmHint: "Your order will be saved and confirmation emails will be sent.",
note: "No shipping. Pickup only at Danely's House. Cash only.",
footer: "Â© 2025 Armando Gomez. All rights reserved.",
pickup: `Pickup on: ${PICKUP_DATE} at Danely's House`,
orderSummary: "Order Summary",
item: "Item",
quantity: "Quantity",
price: "Price",
subtotal: "Subtotal",
total: "Total",
dozen: "dozen",
},
es: {
brand: "Tamales de Danely",
heroTitle: "Tamales diferentes cada mes",
heroSub: "Hechos a mano por Danely. Solo pago en efectivo.",
signUp: "RegÃ­strese",
logIn: "Iniciar SesiÃ³n",
account: "Cuenta",
loggedInAs: "Conectado como:",
thismonth: `Tamales de este mes (Ordena antes del ${ORDER_BY_DATE})`,
placeOrder: "Realice la Orden",
deleteOrder: "Eliminar",
confirmDelete: "Â¿EstÃ¡ seguro de que desea eliminar esta orden?",
orderPlaced: "Â¡Su orden ha sido realizada! Revise su correo para confirmaciÃ³n.",
orderPlacedTitle: "Â¡Orden Confirmada!",
createAccount: "Crear Cuenta",
back: "AtrÃ¡s",
name: "Nombre",
bday: "Fecha de nacimiento",
email: "Correo electrÃ³nico",
phone: "TelÃ©fono",
verifyTitle: "Verificar correo",
sentTo: "Enviamos un cÃ³digo de 6 dÃ­gitos a",
submit: "Enviar",
resend: "Reenviar",
loginTitle: "Iniciar SesiÃ³n",
loginEmailLabel: "Correo electrÃ³nico",
loginBdayLabel: "Fecha de nacimiento",
loginButton: "Iniciar SesiÃ³n",
loginHint: "Ingrese su correo electrÃ³nico y fecha de nacimiento para iniciar sesiÃ³n.",
accountTitle: "Mi Cuenta",
pastOrders: "Pedidos Anteriores",
noPastOrders: "No pedidos anteriores",
backToMenu: "Regresar al MenÃº",
logout: "Cerrar sesiÃ³n",
confirmTitle: "Resumen del Pedido",
placeOrderBtn: "Realice la Orden",
modifyOrder: "Modifique la Orden",
confirmHint: "Su pedido serÃ¡ guardado y se enviarÃ¡n correos de confirmaciÃ³n.",
note: "No se realizan envÃ­os. Recogida Ãºnicamente en casa de Danely. Solo se acepta pago en efectivo.",
footer: "Â© 2025 Armando Gomez. Todos los derechos reservados.",
pickup: `Recoger el: ${PICKUP_DATE} en Casa de Danely`,
orderSummary: "Resumen del Pedido",
item: "ArtÃ­culo",
quantity: "Cantidad",
price: "Price",
subtotal: "Subtotal",
total: "Total",
dozen: "docena",
}
};

const TAMALES_DATA = [
{
id: 'chicken-green',
emoji: 'ðŸ«”',
nameEN: 'Chicken in Green Sauce',
nameES: 'Pollo en Salsa Verde',
descEN: 'Traditional handmade chicken tamales in green sauce.',
descES: 'Tamales tradicionales de pollo hechos a mano en salsa verde.',
pricePerDozen: 30,
color: '#4CAF50',  // Green color
maxInventory: 10  // Maximum dozens available
},
{
id: 'chicken-mole',
emoji: 'ðŸ«”',
nameEN: 'Chicken in Mole',
nameES: 'Pollo en Mole',
descEN: 'Traditional handmade chicken tamales in mole.',
descES: 'Tamales tradicionales de pollo hechos a mano en mole.',
pricePerDozen: 30,
color: '#6B4423',  // Brown/mole color
maxInventory: 10  // Maximum dozens available
}
];

const API_URL = '';

let appData = {
lang: 'en',
orders: [],
session: null
};

let LANG = appData.lang;
let qty = {};
let currentUser = null;
let currentVerification = null;
let pendingOrder = null;
let inventory = {}; // Track remaining inventory

// Initialize inventory from TAMALES_DATA
TAMALES_DATA.forEach(tamale => {
  inventory[tamale.id] = tamale.maxInventory;
});

TAMALES_DATA.forEach(tamale => {
qty[tamale.id] = 0;
});

const views = {
home: document.getElementById('home'),
signup: document.getElementById('signup'),
verify: document.getElementById('verify'),
login: document.getElementById('login'),
account: document.getElementById('account'),
confirm: document.getElementById('confirm')
};

const dom = {
btnEn: document.getElementById('btn-en'),
btnEs: document.getElementById('btn-es'),
brand: document.getElementById('brand'),
heroTitle: document.getElementById('hero-title'),
heroSub: document.getElementById('hero-sub'),
goSignUp: document.getElementById('goSignUp'),
goLogin: document.getElementById('goLogin'),
tamalesContainer: document.getElementById('tamales-container'),
placeOrderBtn: document.getElementById('placeOrderBtn'),
goBackFromSignup: document.getElementById('backFromSignup'),
createAccount: document.getElementById('createAccount'),
inputs: {
name: document.getElementById('name'),
birthday: document.getElementById('birthday'),
email: document.getElementById('email'),
phone: document.getElementById('phone')
},
verify: {
sentTo: document.getElementById('sent-to'),
codeInput: document.getElementById('codeInput'),
submitCode: document.getElementById('submitCode'),
resend: document.getElementById('resendCode'),
back: document.getElementById('backFromVerify')
},
login: {
email: document.getElementById('loginEmail'),
bday: document.getElementById('loginBday'),
loginButton: document.getElementById('loginButton'),
back: document.getElementById('backFromLogin')
},
accountInfo: document.getElementById('accountInfo'),
pastOrders: document.getElementById('pastOrders'),
logoutBtn: document.getElementById('logoutBtn'),
confirmSummary: document.getElementById('confirm-summary'),
placeOrderBtn2: document.getElementById('placeOrderBtn2'),
modifyOrder: document.getElementById('modifyOrder'),
footerText: document.getElementById('footer-text')
};

function showToast(message, isError = false) {
const toast = document.createElement('div');
toast.style.cssText = `
position: fixed;
top: 20px;
left: 50%;
transform: translateX(-50%);
background: ${isError ? '#E65100' : '#2E7D32'};
color: white;
padding: 1em 2em;
border-radius: 8px;
z-index: 9999;
box-shadow: 0 4px 12px rgba(0,0,0,0.3);
animation: slideDown 0.3s ease;
max-width: 90%;
text-align: center;
`;
toast.textContent = message;
document.body.appendChild(toast);
setTimeout(() => {
toast.style.animation = 'slideUp 0.3s ease';
setTimeout(() => toast.remove(), 300);
}, 3000);
}

function t(key) {
return STRINGS[LANG][key] || STRINGS.en[key] || key;
}

function switchTo(view) {
  Object.values(views).forEach(v => v.classList.add('hidden'));
  views[view].classList.remove('hidden');
  if (view === 'home') renderHome();
  if (view === 'account') renderAccount();  // Make sure this line exists
  if (view === 'confirm') renderConfirm();
}

function formatCurrency(n) {
return `$${(n).toFixed(2)}`;
}

async function saveUserToStorage(user) {
try {
const response = await fetch(`${API_URL}/api`, {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({
action: 'createUser',
...user
})
});
const data = await response.json();
return data;
} catch (error) {
console.error('Error saving user:', error);
showToast('Error saving user data. Please try again.', true);
}
}

async function loadUserByEmail(email) {
try {
const response = await fetch(`${API_URL}/api?action=getUser&email=${encodeURIComponent(email)}`);
const data = await response.json();
return data.user || null;
} catch (error) {
console.error('Error loading user:', error);
return null;
}
}

async function saveOrder(order) {
const result = await saveOrderToDB(order);
console.log('saveOrderToDB result:', result);
if (result && result.success) {
appData.orders.unshift({...order, id: result.orderId});
return result;
}
return null;
}

function renderHome() {
const authButtons = document.getElementById('auth-buttons');
const loggedInCard = document.getElementById('logged-in-card');
const loggedInName = document.getElementById('logged-in-name');
const loggedInText = document.getElementById('logged-in-text');

if (currentUser) {
authButtons.classList.add('hidden');
loggedInCard.classList.remove('hidden');
loggedInName.textContent = currentUser.name;
loggedInText.textContent = t('loggedInAs');
} else {
authButtons.classList.remove('hidden');
loggedInCard.classList.add('hidden');
}

const container = dom.tamalesContainer;
container.innerHTML = '';

TAMALES_DATA.forEach(tamale => {
const nameKey = LANG === 'es' ? 'nameES' : 'nameEN';
const descKey = LANG === 'es' ? 'descES' : 'descEN';
const priceText = LANG === 'es' ? `${tamale.pricePerDozen} / docena` : `${tamale.pricePerDozen} / dozen`;

const card = document.createElement('div');
card.className = 'card';
const remaining = inventory[tamale.id] || 0;
const soldOut = remaining === 0;
const lowStock = remaining > 0 && remaining <= 3;

card.innerHTML = `
<div class="menu-card ${soldOut ? 'faded' : ''}" data-card-id="${tamale.id}">
<div class="tamale-illus" style="--tamale-color: ${tamale.color}">${tamale.emoji}</div>
<div class="menu-right">
<div style="font-weight:800;font-size:1.125em">${tamale[nameKey]}</div>
<div class="muted">${tamale[descKey]}</div>
<div class="price">$${priceText}</div>
<div style="margin-top:0.375em;font-size:0.8125em;font-weight:600;color:${soldOut ? '#C62828' : lowStock ? '#F57C00' : '#2E7D32'}">
  ${soldOut ? (LANG === 'es' ? 'Â¡Agotado!' : 'Sold Out!') : (LANG === 'es' ? `${remaining} docenas disponibles` : `${remaining} dozen available`)}
</div>
<div class="qty" style="margin-top:0.625em;">
<button class="qty-minus" data-id="${tamale.id}" aria-label="Decrease dozens" ${soldOut ? 'disabled' : ''}>âˆ’</button>
<div class="count" data-id="${tamale.id}">${qty[tamale.id]}</div>
<button class="qty-plus" data-id="${tamale.id}" aria-label="Increase dozens" ${soldOut ? 'disabled' : ''}>+</button>
</div>
<div class="total">Total: <span class="total-amount" data-id="${tamale.id}">${formatCurrency(qty[tamale.id] * tamale.pricePerDozen)}</span></div>
</div>
</div>
`;
container.appendChild(card);
});

document.querySelectorAll('.qty-minus').forEach(btn => {
btn.addEventListener('click', (e) => {
const id = e.target.dataset.id;
const tamale = TAMALES_DATA.find(t => t.id === id);
if (qty[id] > 0) {
qty[id]--;
updateTamaleQty(id, tamale);
}
});
});

document.querySelectorAll('.qty-plus').forEach(btn => {
btn.addEventListener('click', (e) => {
const id = e.target.dataset.id;
const tamale = TAMALES_DATA.find(t => t.id === id);
const remaining = inventory[id] || 0;
if (qty[id] < remaining && qty[id] < 20) {
qty[id]++;
updateTamaleQty(id, tamale);
}
});
});
}

function updateTamaleQty(id, tamale) {
const currentQty = qty[id];
document.querySelector(`.count[data-id="${id}"]`).textContent = currentQty.toString();
const total = currentQty * tamale.pricePerDozen;
document.querySelector(`.total-amount[data-id="${id}"]`).textContent = formatCurrency(total);

const minusBtn = document.querySelector(`.qty-minus[data-id="${id}"]`);
minusBtn.disabled = (currentQty === 0);

const card = document.querySelector(`.menu-card[data-card-id="${id}"]`);
if (currentQty === 0) {
card.classList.add('faded');
} else {
card.classList.remove('faded');
}
}

function applyLang() {
dom.brand.textContent = t('brand');
dom.heroTitle.textContent = t('heroTitle');
dom.heroSub.textContent = t('heroSub');
dom.goSignUp.textContent = t('signUp');
dom.goLogin.textContent = t('logIn');
document.getElementById('this-month').textContent = t('thismonth');
document.getElementById('pickup-note').textContent = t('note');
document.getElementById('placeOrderBtn').textContent = t('placeOrder');
document.getElementById('signup-title').textContent = t('createAccount');
document.getElementById('createAccount').textContent = t('createAccount');
document.getElementById('backFromSignup').textContent = t('back');
document.getElementById('label-name').textContent = t('name');
document.getElementById('label-bday').textContent = t('bday');
document.getElementById('label-email').textContent = t('email');
document.getElementById('label-phone').textContent = t('phone');
document.getElementById('verify-title').textContent = t('verifyTitle');
dom.verify.sentTo.textContent = `${t('sentTo')} ${currentVerification ? currentVerification.email : ''}`;
document.getElementById('submitCode').textContent = t('submit');
document.getElementById('resendCode').textContent = t('resend');
document.getElementById('backFromVerify').textContent = t('back');
document.getElementById('login-title').textContent = t('loginTitle');
document.getElementById('label-login-email').textContent = t('loginEmailLabel');
document.getElementById('label-login-bday').textContent = t('loginBdayLabel');
document.getElementById('loginButton').textContent = t('loginButton');
document.getElementById('backFromLogin').textContent = t('back');
document.getElementById('login-hint').textContent = t('loginHint');
document.getElementById('account-title').textContent = t('accountTitle');
document.getElementById('past-orders-title').textContent = t('pastOrders');
document.getElementById('confirm-title').textContent = t('confirmTitle');
document.getElementById('placeOrderBtn2').textContent = t('placeOrderBtn');
document.getElementById('modifyOrder').textContent = t('modifyOrder');
document.getElementById('confirm-hint').textContent = t('confirmHint');
const goAccountBtn = document.getElementById('goAccount');
if (goAccountBtn) goAccountBtn.textContent = t('account');
const backToHomeBtn = document.getElementById('backToHome');
if (backToHomeBtn) backToHomeBtn.textContent = t('backToMenu');
const logoutBtn = document.getElementById('logoutBtn');
if (logoutBtn) logoutBtn.textContent = t('logout');
dom.footerText.textContent = t('footer');
renderHome();
}

async function init() {
  dom.btnEn.addEventListener('click', () => {
    LANG = 'en';
    appData.lang = 'en';
    applyLang();
  });

  dom.btnEs.addEventListener('click', () => {
    LANG = 'es';
    appData.lang = 'es';
    applyLang();
  });

  dom.brand.addEventListener('click', () => switchTo('home'));
  dom.goSignUp.addEventListener('click', () => switchTo('signup'));
  dom.goLogin.addEventListener('click', () => switchTo('login'));

  const goAccountBtn = document.getElementById('goAccount');
  if (goAccountBtn) goAccountBtn.addEventListener('click', () => switchTo('account'));

  dom.placeOrderBtn.addEventListener('click', () => {
    if (!currentUser) {
      showToast('Please log in or sign up to place an order.', true);
      switchTo('login');
      return;
    }
    prepareOrder();
    switchTo('confirm');
  });

  dom.createAccount.addEventListener('click', createAccountFlow);
  dom.goBackFromSignup && dom.goBackFromSignup.addEventListener('click', () => switchTo('home'));
  dom.verify.submitCode.addEventListener('click', submitVerificationCode);
  dom.verify.resend.addEventListener('click', resendVerification);
  dom.verify.back.addEventListener('click', () => switchTo('signup'));
  dom.login.loginButton.addEventListener('click', loginUser);

  dom.logoutBtn.addEventListener('click', () => {
    currentUser = null;
    appData.session = null;

    TAMALES_DATA.forEach(tamale => {
      qty[tamale.id] = 0;
    });

    const goAccountBtn = document.getElementById('goAccount');
    if (goAccountBtn) goAccountBtn.classList.add('hidden');

    switchTo('home');
  });

  const backToHomeBtn = document.getElementById('backToHome');
  if (backToHomeBtn) backToHomeBtn.addEventListener('click', () => switchTo('home'));
  dom.login.back.addEventListener('click', () => switchTo('home'));
  dom.placeOrderBtn2.addEventListener('click', sendEmailsForOrder);
  dom.modifyOrder.addEventListener('click', () => switchTo('home'));

  // Load inventory from database FIRST, then render
  await loadInventoryFromDB();

  applyLang();
  renderHome();
  switchTo('home');
}

async function createAccountFlow() {
  const name = dom.inputs.name.value.trim();
  const bday = dom.inputs.birthday.value;
  const email = dom.inputs.email.value.trim().toLowerCase();
  const phone = dom.inputs.phone.value.trim();

  if (!name || !email) {
    showToast('Please provide your name and email.', true);
    return;
  }

  const code = Math.floor(100000 + Math.random() * 900000).toString();
  const code_created_at = Date.now();

  const user = {
    name,
    birthday: bday,
    email,
    phone,
    verification_code: code,
    code_created_at: code_created_at,
    createdAt: new Date().toISOString()
  };

  // Save user to database FIRST
  await saveUserToStorage(user);

  // Then send verification email
  await fetch(`${API_URL}/api`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      action: 'sendVerificationEmail',
      email,
      name,
      code
    })
  });

  currentVerification = {email, code, createdAt: code_created_at};
  dom.verify.sentTo.textContent = `${t('sentTo')} ${email}`;
  switchTo('verify');
}

async function submitVerificationCode() {
const entered = dom.verify.codeInput.value.trim();
if (!currentVerification) {
showToast('No verification pending. Please sign up or request a code.', true);
return;
}

try {
const response = await fetch(`${API_URL}/api`, {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({
action: 'verifyUser',
email: currentVerification.email,
code: entered
})
});

const data = await response.json();

if (data.success) {
currentUser = data.user;
appData.session = {email: currentUser.email};
currentVerification = null;
dom.verify.codeInput.value = '';
const goAccountBtn = document.getElementById('goAccount');
if (goAccountBtn) goAccountBtn.classList.remove('hidden');
showToast('Verified! You are now logged in.');
switchTo('home');
} else {
showToast('Code incorrect. Try Resend.', true);
}
} catch (error) {
console.error('Verification error:', error);
showToast('Error verifying code. Please try again.', true);
}
}

async function resendVerification() {
if (!currentVerification) {
showToast('No verification in progress.', true);
return;
}

const code = Math.floor(100000 + Math.random() * 900000).toString();

try {
await fetch(`${API_URL}/api`, {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({
action: 'sendVerificationEmail',
email: currentVerification.email,
code
})
});

currentVerification.code = code;
currentVerification.createdAt = Date.now();
dom.verify.sentTo.textContent = `${t('sentTo')} ${currentVerification.email}`;

showToast('A new verification code has been sent to your email.');
} catch (err) {
console.error(err);
showToast('Failed to resend verification email.', true);
}
}

async function loginUser() {
const email = dom.login.email.value.trim().toLowerCase();
const bday = dom.login.bday.value;

if (!email || !bday) {
showToast('Please provide both email and birthday.', true);
return;
}

const user = await loadUserByEmail(email);

if (!user) {
showToast('No account found with that email. Please sign up.', true);
return;
}

if (user.birthday !== bday) {
showToast('Birthday does not match our records. Please try again.', true);
return;
}

currentUser = user;
appData.session = {email: currentUser.email};
const goAccountBtn = document.getElementById('goAccount');
if (goAccountBtn) goAccountBtn.classList.remove('hidden');

dom.login.email.value = '';
dom.login.bday.value = '';

showToast('Logged in successfully!');
switchTo('home');
}

async function renderAccount() {
  if (!currentUser) {
    dom.accountInfo.textContent = 'Not logged in';
    dom.pastOrders.textContent = t('noPastOrders');
    return;
  }

  const freshUser = await loadUserByEmail(currentUser.email);
  if (freshUser) {
    currentUser = freshUser;
  }

  dom.accountInfo.innerHTML = `<strong>${currentUser.name}</strong><br>${currentUser.email}<br>${currentUser.phone || ''}`;

  const orders = await loadOrdersFromDB(currentUser.email);
  console.log('Orders for current user:', orders);

  if (!orders.length) {
    dom.pastOrders.textContent = t('noPastOrders');
  } else {
    dom.pastOrders.innerHTML = orders.map(o => {
      let itemsText = o.items.map(item => `${item.qty} doz ${item.name}`).join(', ');
      return `
        <div style="margin-bottom:0.75em;padding:0.75em;background:rgba(255,255,255,0.5);border-radius:0.5em;">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.375em;">
            <strong style="flex:1">${itemsText}</strong>
            <button
              class="delete-order-btn"
              data-order-id="${o.id}"
              style="background:var(--cta);color:var(--cta-text);border:none;padding:0.375em 0.75em;border-radius:0.375em;cursor:pointer;font-size:0.75em;font-weight:600;"
            >
              ${t('deleteOrder')}
            </button>
          </div>
          <div>Total: ${formatCurrency(o.grand_total)}</div>
          <div class="small muted">${new Date(o.created_at).toLocaleString()}</div>
        </div>
      `;
    }).join('');

    document.querySelectorAll('.delete-order-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const orderId = parseInt(e.target.dataset.orderId);
        if (confirm(t('confirmDelete'))) {
          const success = await deleteOrderFromDB(orderId, currentUser.email);
          if (success) {
            await loadInventoryFromDB();
            renderAccount();
            showToast('Order deleted and inventory restored.', false);
          } else {
            showToast('Error deleting order. Please try again.', true);
          }
        }
      });
    });
  }
}

function prepareOrder() {
  if (!currentUser) {
    showToast('Please log in or sign up to place an order.', true);
    switchTo('login');
    return;
  }

  const orderItems = [];
  let grandTotal = 0;

  TAMALES_DATA.forEach(tamale => {
    if (qty[tamale.id] > 0) {
      const nameKey = LANG === 'es' ? 'nameES' : 'nameEN';
      const itemTotal = qty[tamale.id] * tamale.pricePerDozen;
      orderItems.push({
        id: tamale.id,
        name: tamale[nameKey],
        qty: qty[tamale.id],
        pricePerDozen: tamale.pricePerDozen,
        total: itemTotal
      });
      grandTotal += itemTotal;
    }
  });

  if (orderItems.length === 0) {
    showToast('Please add at least one dozen tamales to your order.', true);
    return;
  }

  pendingOrder = {
    items: orderItems,
    grandTotal,
    email: currentUser.email,
    name: currentUser.name,
    phone: currentUser.phone,
    createdAt: new Date().toISOString()
  };
}

function renderConfirm() {
  if (!pendingOrder) {
    dom.confirmSummary.textContent = 'No order prepared.';
  } else {
    let summaryHTML = `
      <div style="border-bottom:0.125em solid var(--accent-dark);padding-bottom:0.5em;margin-bottom:0.75em;">
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="border-bottom:0.0625em solid rgba(0,0,0,0.1);">
              <th style="text-align:left;padding:0.5em 0;font-size:0.875em;color:var(--muted)">${t('item')}</th>
              <th style="text-align:center;padding:0.5em 0;font-size:0.875em;color:var(--muted)">${t('quantity')}</th>
              <th style="text-align:right;padding:0.5em 0;font-size:0.875em;color:var(--muted)">${t('price')}</th>
            </tr>
          </thead>
          <tbody>
    `;

    pendingOrder.items.forEach(item => {
      summaryHTML += `
        <tr style="border-bottom:0.0625em solid rgba(0,0,0,0.05);">
          <td style="padding:0.625em 0;font-weight:600">${item.name}</td>
          <td style="text-align:center;padding:0.625em 0">${item.qty} ${t('dozen')}</td>
          <td style="text-align:right;padding:0.625em 0">${formatCurrency(item.total)}</td>
        </tr>
      `;
    });

    summaryHTML += `
          </tbody>
        </table>
      </div>
      <div style="text-align:right;margin-top:0.75em;">
        <div style="font-size:1.25em;font-weight:800;color:var(--accent-dark);margin-bottom:0.5em;">
          ${t('total')}: ${formatCurrency(pendingOrder.grandTotal)}
        </div>
        <div style="font-size:0.875em;color:var(--muted);margin-top:0.375em;">
          ${t('pickup')}
        </div>
      </div>
    `;

    dom.confirmSummary.innerHTML = summaryHTML;
  }
}

async function sendEmailsForOrder() {
  if (!pendingOrder) {
    showToast('No order to send.', true);
    return;
  }

  console.log('Saving order:', pendingOrder);

  try {
    dom.placeOrderBtn2.disabled = true;
    dom.placeOrderBtn2.textContent = 'Processing...';

    const saveResult = await saveOrder(pendingOrder);
    console.log('Save result:', saveResult);

    if (!saveResult || !saveResult.success) {
      throw new Error('Failed to save order');
    }

    const emailResponse = await fetch(`${API_URL}/api`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        action: 'sendOrderEmails',
        order: pendingOrder
      })
    });

    const emailResult = await emailResponse.json();
    console.log('Email result:', emailResult);

    if (emailResult.success) {
      showToast(t('orderPlaced'));
    } else {
      showToast('Order saved! Confirmation email will be sent shortly.');
    }

    TAMALES_DATA.forEach(tamale => {
      qty[tamale.id] = 0;
    });
    pendingOrder = null;

    await loadInventoryFromDB();

    setTimeout(() => switchTo('home'), 1500);

  } catch (error) {
    console.error('Error placing order:', error);
    showToast('Error placing order. Please try again.', true);

    dom.placeOrderBtn2.disabled = false;
    dom.placeOrderBtn2.textContent = t('placeOrderBtn');
  }
}

async function saveOrderToDB(order) {
  try {
    console.log('Calling API to save order...');
    const response = await fetch(`${API_URL}/api`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        action: 'createOrder',
        user_email: order.email,
        user_name: order.name,
        user_phone: order.phone,
        items: order.items,
        grand_total: order.grandTotal,
        created_at: order.createdAt
      })
    });
    const data = await response.json();
    console.log('API response:', data);
    return data;
  } catch (error) {
    console.error('Error saving order:', error);
    return null;
  }
}

async function loadInventoryFromDB() {
  try {
    const response = await fetch(`${API_URL}/api?action=getInventory`);
    const data = await response.json();

    if (data.inventory) {
      Object.keys(data.inventory).forEach(tamaleId => {
        inventory[tamaleId] = data.inventory[tamaleId];
      });
    }
  } catch (error) {
    console.error('Error loading inventory:', error);
  }
}

async function loadOrdersFromDB(email) {
  try {
    console.log('Loading orders for:', email);
    const response = await fetch(`${API_URL}/api?action=getOrders&email=${encodeURIComponent(email)}`);
    const data = await response.json();
    console.log('Orders loaded:', data.orders);
    return data.orders || [];
  } catch (error) {
    console.error('Error loading orders:', error);
    return [];
  }
}

async function deleteOrderFromDB(orderId, userEmail) {
  try {
    const response = await fetch(`${API_URL}/api`, {
      method: 'DELETE',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        action: 'deleteOrder',
        orderId: orderId,
        userEmail: userEmail
      })
    });
    const data = await response.json();
    return data.success;
  } catch (error) {
    console.error('Error deleting order:', error);
    return false;
  }
}

init();

</script>

</body>
</html>